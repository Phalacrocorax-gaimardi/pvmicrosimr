sD <- scenario_wem
scenario_wem <- readxl::read_xlsx("~/Policy/AgentBasedModels/solarPV/scenario_parameters.xlsx", sheet="scenario_WEM")
use_data(scenario_wem,overwrite = T,version=3)
sD <- scenario_wem
yeartime <- 2045
#
du_social <- dplyr::filter(empirical_u,code=="qsp21")$du_average
theta <- dplyr::filter(empirical_u,code=="theta")$du_average
empirical_u = empirical_utils
#
du_social <- dplyr::filter(empirical_u,code=="qsp21")$du_average
theta <- dplyr::filter(empirical_u,code=="theta")$du_average
#params at yeartime
params <- scenario_params_df(sD,yeartime)
#self-sufficiency
averse <- c(0,0,0,aversion_4.,aversion_5.)*params$self_sufficiency_effect
#parameters from scenario corresponding to yeartime
kWpm2 <- params$kWp_per_m2
a_s <- agents_in
a_s$transaction <- F
a_s <- dplyr::ungroup(a_s)
a_s <- a_s %>% dplyr::mutate(old_imports=new_imports,old_exports=new_imports,old_solar1=new_solar1,old_solar2 = new_solar2,old_battery=new_battery)
#this subsample of agents decide to look at rooftop pv
b_s <- dplyr::slice_sample(a_s,n=roundr(dim(a_s)[1]*p.*params$acceleration_factor))
b_s <- b_s %>% dplyr::mutate(transaction=T) %>% dplyr::select(ID,housecode,house_type,aspect,area1,area2,shading1,shading2,w_q9_1,w_qsp21,w_theta,q9_1,qsp21,old_imports, old_exports,old_solar1,old_solar2,old_battery)
b_s
dim(a_s)[1]*p.*params$acceleration_factor
p.
kWpm2
#pv rooftop capacity constrained finacial utilities corresponding to costs in params
#find current (old) values of imports and exports
cer_sys <- b_s %>% dplyr::left_join(dplyr::bind_rows(cer_systems1,cer_systems2,cer_systems3,cer_systems4))
dim(b_s)
dim(cer_sys)
dim(cer_sys)[1]/6
cer_sys$solar1 %>% unique()
cer_sys$solar1 %>% unique() %>% length()
cer_sys$battery %>% unique() %>% length()
cer_sys$battery %>% unique()
51^2*9
cer_sys
#cer_sys <- b_s %>% dplyr::left_join(cer_systems)
#new system is an enhancement
cer_sys <- cer_sys %>% dplyr::filter(solar1 <= kWpm2*area1,solar1 >= old_solar1, solar2 <= kWpm2*area2, solar2 >= old_solar2, battery >= old_battery)
cer_sys
b_s
b_s[1,"old_solar1"]
b_s[1,"new_solar1"]
b_s[1,"old_solar1"]
#add shading factors in financial utility!
cer_sys <- cer_sys %>% dplyr::mutate(du=get_sys_util_0(params,demand,old_imports,old_exports,old_solar1,old_solar2,old_battery,imports,exports,solar1-old_solar1,solar2-old_solar2,battery-old_battery))
cer_sys
cer_sys %>% dim()
#pv rooftop capacity constrained finacial utilities corresponding to costs in params
#find current (old) values of imports and exports
cer_sys <- b_s %>% dplyr::left_join(dplyr::bind_rows(cer_systems1,cer_systems2,cer_systems3,cer_systems4))
cer_sys <- get_shaded_sys(cer_sys)
cer_sys
60*kWpm2
cer_sys$solar1 %>% unique()
#pv rooftop capacity constrained finacial utilities corresponding to costs in params
#find current (old) values of imports and exports
cer_sys <- b_s %>% dplyr::left_join(dplyr::bind_rows(cer_systems1,cer_systems2,cer_systems3,cer_systems4))
cer_sys <- get_shaded_sys(cer_sys)
#cer_sys <- b_s %>% dplyr::left_join(cer_systems)
#new system is an enhancement
#area1,2 is the remaining area for solar
cer_sys <- cer_sys %>% dplyr::filter(solar1 <= old_solar+kWpm2*area1,solar2 <= old_solar2+kWpm2*area2, battery >= old_battery)
#cer_sys <- b_s %>% dplyr::left_join(cer_systems)
#new system is an enhancement
#area1,2 is the remaining area for solar
cer_sys <- cer_sys %>% dplyr::filter(solar1 <= old_solar1+kWpm2*area1,solar2 <= old_solar2+kWpm2*area2, battery >= old_battery)
dim(cer_sys)
dim(cer_sys)[1]/6
#add shading factors in financial utility!
cer_sys <- cer_sys %>% dplyr::mutate(du=get_sys_util_0(params,demand,old_imports,old_exports,old_solar1,old_solar2,old_battery,imports,exports,solar1-old_solar1,solar2-old_solar2,battery-old_battery))
#optimal
cer_sys_opt <- cer_sys %>% dplyr::group_by(housecode) %>% dplyr::filter(du==max(du))
system.time(cer_sys %>% dplyr::mutate(du=get_sys_util_0(params,demand,old_imports,old_exports,old_solar1,old_solar2,old_battery,imports,exports,solar1-old_solar1,solar2-old_solar2,battery-old_battery))
)
dim(cer_sys)
149.53/24210
#optimal
cer_sys_opt <- cer_sys %>% dplyr::group_by(housecode) %>% dplyr::filter(du==max(du))
#reduce available area by
cer_sys_opt <- cer_sys_opt %>% dplyr::mutate(area1 = area1 - (solar1-old_solar1)/kWpm2, area2 = area2 - (solar2-old_solar2)/kWpm2)
cer_sys_opt <- cer_sys_opt %>% dplyr::rename(new_solar1=solar1,new_solar2 = solar2,new_battery=battery,new_imports=imports,new_exports=exports)
load_all()
document()
check()
install()
install()
library(devtools)
load_all()
check()
install()
12*800
library(tidyverse)
library(pvmicrosimr)
library(zoo)
#library(pvcalibrater)
library(lubridate)
library(ggthemes)
#adopters
abm <- readRDS("~/Policy/AgentBasedModels/solarPV/scenario_runs/scenario_wem/abm_64runs_2050_shading.RData") #self-sufficiency premium maintained
abm[[2]]
abm[[2]] %>% filter(str_detect(parameter,"ceg"))
abm[[2]] %>% filter(str_detect(parameter,"bat"))
#adopters
abm <- readRDS("~/Policy/AgentBasedModels/solarPV/scenario_runs/scenario_wem/abm_64runs_2050_shading.RData") #self-sufficiency premium maintained
groupvars <- c("simulation","date","aspect")
groupvars <- c("simulation","date","aspect")
#total uptake in GW and GWh (battery)
cap <- abm0 %>% group_by(groupvars) %>% summarise(solar1=sum(new_solar1)/759*1.1, solar2 = sum(new_solar2)/759*1.1, battery=sum(new_battery)/759*1.1)
groupvars
#total uptake in GW and GWh (battery)
cap <- abm0 %>% group_by(all_of(groupvars)) %>% summarise(solar1=sum(new_solar1)/759*1.1, solar2 = sum(new_solar2)/759*1.1, battery=sum(new_battery)/759*1.1)
#cap <- abm[[1]] %>% mutate(date=date_decimal(2010+(t-1)/6))
#abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2))
abm0 <- abm %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2))
#cap <- abm[[1]] %>% mutate(date=date_decimal(2010+(t-1)/6))
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2))
#total uptake in GW and GWh (battery)
cap <- abm0 %>% group_by(all_of(groupvars)) %>% summarise(solar1=sum(new_solar1)/759*1.1, solar2 = sum(new_solar2)/759*1.1, battery=sum(new_battery)/759*1.1)
#total uptake in GW and GWh (battery)
cap <- abm0 %>% group_by(across(all_of(groupvars))) %>% summarise(solar1=sum(new_solar1)/759*1.1, solar2 = sum(new_solar2)/759*1.1, battery=sum(new_battery)/759*1.1)
cap
get_capacities <- function(abm,groupvars = "date", house_stock = 1.1){
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
cap <- abm0 %>% group_by(across(all_of(groupvars)))  %>% summarise(solar1=sum(new_solar1)/759*house_stock, solar2 = sum(new_solar2)/759*house_stock, battery=sum(new_battery)/759*house_stock)
}
get_capacities(abm)
get_capacities <- function(abm,groupvars = c("scenario","date"), house_stock = 1.1){
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
cap <- abm0 %>% group_by(across(all_of(groupvars)))  %>% summarise(solar1=sum(new_solar1)/759*house_stock, solar2 = sum(new_solar2)/759*house_stock, battery=sum(new_battery)/759*house_stock)
}
get_capacities(abm)
get_capacities <- function(abm,groupvars = c("simulation","date"), house_stock = 1.1){
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
cap <- abm0 %>% group_by(across(all_of(groupvars)))  %>% summarise(solar1=sum(new_solar1)/759*house_stock, solar2 = sum(new_solar2)/759*house_stock, battery=sum(new_battery)/759*house_stock)
}
get_capacities(abm)
get_capacities <- function(abm,groupvars = c("simulation","date"), house_stock = 1.1){
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
cap <- abm0 %>% group_by(across(all_of(groupvars)))  %>% summarise(solar1=sum(new_solar1)/759*house_stock, solar2 = sum(new_solar2)/759*house_stock, battery=sum(new_battery)/759*house_stock)
return(cap)
}
get_capacities(abm)
get_capacities(abm) %>% filter(date=="2022-12-01")
test <- get_capacities(abm)
test
test %>% filter(date=="2022-12-01")
test
test %>% filter(date=="2022-12-01")
test
test <- test %>% group_by(date) %>% summarise(GW=mean(solar1+solar2), GWh - mean(battery))
test <- test %>% group_by(date) %>% summarise(GW=mean(solar1+solar2), GWh = mean(battery))
test %>% filter(date=="2022-12-01")
test %>% filter(date=="2018-16-01")
test %>% filter(date=="2018-06-01")
0.0012*1000
test %>% filter(date=="2018-12-01")
0.02*1000
test %>% filter(date=="2018-08-01")
test %>% filter(date=="2018-08-01")
groupvars <- c("simulation","date",groupvars)
groupvars
groupvars = NULL
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n())
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n())
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2) %>% summarise(all=n())
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n())
inner_join(attached,all)
abm0
abm0$date[1]
dim(all)
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n())
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n())
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- inner_join(attached,all) %>% mutate(sar=attached/all)
all <- dates %>% left_join(all)
all
get_uptake <- function(abm,groupvars = NULL, house_stock = 1.1){
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n())
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n())
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- inner_join(attached,all) %>% mutate(sar=attached/all)
all <- dates %>% left_join(all)
return(all)
}
test <- get_uptake(abm)
test
test %>% tail()
test %>% group_by(date) %>% summarise(sar=mean(sar))
sar <- test %>% group_by(date) %>% summarise(sar=mean(sar))
sar %>% ggplot(aes(date,sar)) + geom_line()
get_uptake <- function(abm,groupvars = NULL, house_stock = 1.1){
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n())
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n())
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- inner_join(attached,all) %>% mutate(all=replace_na(all,0),attached=replace_na(attached,0))
%>% mutate(sar=attached/all)
all <- dates %>% left_join(all)
return(all)
}
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n())
all
get_uptake <- function(abm,groupvars = NULL){
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n()/759)
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- inner_join(attached,all) %>% mutate(all=replace_na(all,0),attached=replace_na(attached,0))
all <- all %>% mutate(sar=attached/all)
all <- dates %>% left_join(all)
return(all)
}
test <- get_uptake(abm)
test
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n()/759)
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- inner_join(attached,all) %>% mutate(all=replace_na(all,0),attached=replace_na(attached,0))
all
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- dates %>% left_join(all)
attached <- dates %>% left_join(attached)
all
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- tibble(date=dates)
all <- dates %>% left_join(all)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n()/759)
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(simulation=1:Nrun,date=dates)
all <- dates %>% left_join(all)
attached <- dates %>% left_join(attached)
all
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n()/759)
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(simulation=1:Nrun,date=dates)
all <- dates %>% left_join(all) %>% mutate(all=replace_na(all,0))
attached <- dates %>% left_join(attached) %>% mutate(attached=replace_na(attached,0))
all <- inner_join(attached,all) #%>% mutate(all=replace_na(all,0),attached=replace_na(attached,0))
all <- all %>% mutate(sar=attached/all)
all
all %>% tail()
get_uptake <- function(abm,groupvars = NULL){
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
attached <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0 & new_battery >0 ) %>% summarise(attached=n()/759)
all <- abm0 %>% group_by(across(all_of(groupvars)))  %>% filter(new_solar1+new_solar2 > 0) %>% summarise(all=n()/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(simulation=1:Nrun,date=dates)
all <- dates %>% left_join(all) %>% mutate(all=replace_na(all,0))
attached <- dates %>% left_join(attached) %>% mutate(attached=replace_na(attached,0))
all <- inner_join(attached,all) #%>% mutate(all=replace_na(all,0),attached=replace_na(attached,0))
all <- all %>% mutate(sar=attached/all)
return(all)
}
test <- get_uptake(abm)
test
test %>% ggplot(aes(date,sar,colour=factor(simulation))) + geom_line()
test %>% filter(date=="2023-02-01")
test %>% filter(date=="2023-02-01") %>% summarise(sar=mean(sar))
test %>% filter(date=="2025-02-01") %>% summarise(sar=mean(sar))
test %>% filter(date=="2030-12-01") %>% summarise(sar=mean(sar))
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% dplyr::mutate(date=ymd("2010-02-01") %m+% lubridate::months((t-1)*2)) %>% dplyr::arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
abm0 <- abm[[1]] %>% dplyr::mutate(date=ymd("2010-02-01") %m+% lubridate::months((t-1)*2)) %>% dplyr::arrange(simulation,date)
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% dplyr::mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% dplyr::arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(n=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_ad=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_only=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(simulation=1:Nrun,date=dates)
dates <- abm0$date %>% unique() %>% sort()
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(simulation=1:Nrun,date=dates)
pv_adopt <- dates %>% left_join(all) %>% mutate(all=replace_na(all,0))
pv_adopt
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% dplyr::mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% dplyr::arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(n=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_ad=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_only=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(simulation=1:Nrun,date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(all,0))
pv_augment <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(all,0))
bat_adopt <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(all,0))
bat_augment <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(all,0))
bat_augment_only <- dates %>% left_join(bat_augment_only) %>% mutate(all=replace_na(all,0))
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(n=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_ad=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_only=n()/Nrun/759)
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(b_ad=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_aug=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_o=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(all,0))
pv_adopt
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(pv_ad,0))
pv_augment <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(pv_aug,0))
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(pv_ad,0))
pv_augment <- dates %>% left_join(pv_augment) %>% mutate(all=replace_na(pv_aug,0))
bat_adopt <- dates %>% left_join(bat_adopt) %>% mutate(all=replace_na(b_ad,0))
bat_augment <- dates %>% left_join(bat_augment) %>% mutate(all=replace_na(b_aug,0))
bat_augment_only <- dates %>% left_join(bat_augment_only) %>% mutate(all=replace_na(b_aug_o,0))
pv_adopt
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(b_ad=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_aug=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_o=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(all=replace_na(pv_ad,0))
pv_adopt
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(b_ad=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_aug=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_o=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(pv_ad=replace_na(pv_ad,0))
pv_augment <- dates %>% left_join(pv_augment) %>% mutate(pv_aug=replace_na(pv_aug,0))
bat_adopt <- dates %>% left_join(bat_adopt) %>% mutate(b_ad=replace_na(b_ad,0))
bat_augment <- dates %>% left_join(bat_augment) %>% mutate(b_aug=replace_na(b_aug,0))
bat_augment_only <- dates %>% left_join(bat_augment_only) %>% mutate(b_aug_o=replace_na(b_aug_o,0))
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(b_ad=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_aug=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_o=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(pv_ad=replace_na(pv_ad,0))
pv_augment <- dates %>% left_join(pv_augment) %>% mutate(pv_aug=replace_na(pv_aug,0))
bat_adopt <- dates %>% left_join(bat_adopt) %>% mutate(b_ad=replace_na(b_ad,0))
bat_augment <- dates %>% left_join(bat_augment) %>% mutate(b_aug=replace_na(b_aug,0))
bat_augment_only <- dates %>% left_join(bat_augment_only) %>% mutate(b_aug_o=replace_na(b_aug_o,0))
bat_augment
bat_augment_only
inner_join(pv_adopt,pv_augment)
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(b_ad=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_aug=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_o=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(pv_ad=replace_na(pv_ad,0))
pv_adopt
pv_augment <- dates %>% left_join(pv_augment) %>% mutate(pv_aug=replace_na(pv_aug,0))
bat_adopt <- dates %>% left_join(bat_adopt) %>% mutate(b_ad=replace_na(b_ad,0))
bat_augment <- dates %>% left_join(bat_augment) %>% mutate(b_aug=replace_na(b_aug,0))
bat_augment_only <- dates %>% left_join(bat_augment_only) %>% mutate(b_aug_o=replace_na(b_aug_o,0))
inner_join(pv_adopt,pv_augment)
inner_join(pv_adopt,pv_augment) %>% inner_join(.,bat_adopt)
inner_join(pv_adopt,pv_augment) %>% inner_join(.,bat_adopt) %>% inner_join(.,bat_augment) %>% inner_join(.,bat_augment_only)
all <- inner_join(pv_adopt,pv_augment) %>% inner_join(.,bat_adopt) %>% inner_join(.,bat_augment) %>% inner_join(.,bat_augment_only)
get_adopt_augment <- function(abm,groupvars=NULL,house_stock=1.1){
groupvars <- c("simulation","date",groupvars)
abm0 <- abm[[1]] %>% dplyr::mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% dplyr::arrange(simulation,date)
Nrun <- abm[[3]] %>% dplyr::filter(parameter=="Nrun") %>% dplyr::pull(value)
pv_adopt <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(pv_ad=n()/Nrun/759)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augment <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(pv_aug=n()/Nrun/759)
bat_adopt <- abm0 %>% dplyr::group_by(date) %>% filter(new_battery > 0 & old_battery == 0) %>% dplyr::summarise(b_ad=n()/Nrun)
bat_augment <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0) %>% summarise(b_aug=n()/Nrun/759)
bat_augment_only <- abm0 %>% group_by(date) %>% filter(new_battery > old_battery & old_battery > 0 & new_solar1 == old_solar1 & new_solar2 == old_solar2) %>% summarise(b_aug_o=n()/Nrun/759)
dates <- abm0$date %>% unique() %>% sort()
dates <- expand_grid(date=dates)
pv_adopt <- dates %>% left_join(pv_adopt) %>% mutate(pv_ad=replace_na(pv_ad,0))
pv_augment <- dates %>% left_join(pv_augment) %>% mutate(pv_aug=replace_na(pv_aug,0))
bat_adopt <- dates %>% left_join(bat_adopt) %>% mutate(b_ad=replace_na(b_ad,0))
bat_augment <- dates %>% left_join(bat_augment) %>% mutate(b_aug=replace_na(b_aug,0))
bat_augment_only <- dates %>% left_join(bat_augment_only) %>% mutate(b_aug_o=replace_na(b_aug_o,0))
all <- inner_join(pv_adopt,pv_augment) %>% inner_join(.,bat_adopt) %>% inner_join(.,bat_augment) %>% inner_join(.,bat_augment_only)
return(all)
}
test <- get_adopt_augment(abm)
test
test %>% ggplot(aes(date,pv_ad)) + geom_line()
test %>% ggplot(aes(date,pv_aug)) + geom_line()
test %>% ggplot(aes(date,bat_aug)) + geom_line()
test %>% ggplot(aes(date,b_aug)) + geom_line()
test %>% ggplot(aes(date,b_ad)) + geom_line()
#adopters vs augmenters
abm0 <- abm[[1]] %>% mutate(date=ymd("2010-02-01") %m+% months((t-1)*2)) %>% arrange(simulation,date)
pv_adopters <- abm0 %>% group_by(date) %>% filter((new_solar1 > 0 | new_solar2 >0) & old_solar1==0 & old_solar2==0) %>% summarise(n=n()/64)
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augmenters <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(n=n()/64)
pv_augmenters
#adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759)
pv_augmenters <- abm0 %>% group_by(date) %>% filter((new_solar1 > old_solar1 | new_solar2 > old_solar2) & (old_solar1 > 0 | old_solar2 > 0)) %>% summarise(n=n()/64)
abm0
abm0 %>% filter(new_solar1 > old_solar1 & old_solar1 > 0)
abm0 %>% filter(new_solar1 > old_solar1 & old_solar1 > 0)
abm0 %>% filter(new_solar1 > old_solar1 & old_solar1 == 0)
abm0 %>% filter(new_solar2 > old_solar2 & old_solar1 > 0)
abm0 %>% filter(new_solar2 > old_solar2 & old_solar1 == 0)
abm0 %>% filter(new_solar2 > old_solar2 & old_solar1 > 0)
library(pvmicrosimr)
sessionInfo()
library(tidyverse)
library(pvmicrosimr)
library(zoo)
#library(pvcalibrater)
library(lubridate)
library(ggthemes)
sD <- readxl::read_xlsx("~/Policy/AgentBasedModels/solarPV/scenario_parameters.xlsx",sheet="scenario_WEM")
ber <- read_csv("~/Policy/AgentBasedModels/solarPV/calibration_runs/ber_pv.csv") %>% filter(year>=2010,year < 2023)
file.out <- paste("~/Policy/AgentBasedModels/solarPV/calibration_runs/abm_cal_p.=",cp.,"_lambda.=",clambda.,".RData",sep="")
print(paste("writing to",file.out))
p. <- 0.0095
lambda. <- 0.107
cp. <- sprintf(p., fmt = '%#.4f')
clambda. <- sprintf(lambda., fmt = '%#.4f')
file.out <- paste("~/Policy/AgentBasedModels/solarPV/calibration_runs/abm_cal_p.=",cp.,"_lambda.=",clambda.,".RData",sep="")
print(paste("writing to",file.out))
file.exists(file.out)
sD <- sD %>% mutate(value=replace(value, parameter=="p.", p.))
sD <- sD %>% mutate(value=replace(value, parameter=="lambda.", lambda.))
abm_cal <- runABM(sD,Nrun = 10,simulation_end = 2022, use_parallel = T)
saveRDS(abm_cal,file.out)
ber_adjust <- 0.48 #0.48
adopt_ber <- ber %>% mutate(n_ber=ber_adjust*PV/total) %>% filter(year >= 2015) %>% select(year,n_ber)
adopt <- abm_cal[[1]] %>% group_by(t) %>% filter(new_solar1 > 0  | new_solar2 >0) %>% summarise(n=n()/10)
adopt
abm_cal[[1]]
abm_cal[[1]]$old_battery
abm_cal[[1]]$date
adopt <- abm_cal[[1]] %>% group_by(t) %>% filter(new_solar1 > 0  | new_solar2 >0) %>% summarise(n=n()/10)
adopt <- adopt %>% mutate(date=date_decimal(2010+(t-1)/6))
adopt <- adopt %>% group_by(year=year(date)) %>% summarise(n=mean(n)/759) #mean annual uptake same metric as BER data
g <- adopt %>% ggplot(aes(year,n)) + geom_line() + geom_point() #+ ggtitle(paste("p.=",cp.,"lambda.=",clambda.))
g + geom_line(data=ber,aes(year,ber_adjust*PV/total),colour="red")+geom_point(data=ber,aes(year,ber_adjust*PV/total),colour="red")
p. <- 0.0095
lambda. <- 0.05
cp. <- sprintf(p., fmt = '%#.4f')
clambda. <- sprintf(lambda., fmt = '%#.4f')
file.out <- paste("~/Policy/AgentBasedModels/solarPV/calibration_runs/abm_cal_p.=",cp.,"_lambda.=",clambda.,".RData",sep="")
print(paste("writing to",file.out))
file.exists(file.out)
sD <- sD %>% mutate(value=replace(value, parameter=="p.", p.))
sD <- sD %>% mutate(value=replace(value, parameter=="lambda.", lambda.))
#sD <- sD %>% mutate(value=replace(value, parameter=="pv_cost_2010", 2500))
#sD <- sD %>% mutate(value=replace(value, parameter=="pv_cost_2015", 1800))
abm_cal <- runABM(sD,Nrun = 10,simulation_end = 2022, use_parallel = T)
saveRDS(abm_cal,file.out)
p. <- 0.0095
lambda. <- 0.05
cp. <- sprintf(p., fmt = '%#.4f')
clambda. <- sprintf(lambda., fmt = '%#.4f')
file.out <- paste("~/Policy/AgentBasedModels/solarPV/calibration_runs/abm_cal_p.=",cp.,"_lambda.=",clambda.,".RData",sep="")
print(paste("writing to",file.out))
file.exists(file.out)
sD <- sD %>% mutate(value=replace(value, parameter=="p.", p.))
sD <- sD %>% mutate(value=replace(value, parameter=="lambda.", lambda.))
#sD <- sD %>% mutate(value=replace(value, parameter=="pv_cost_2010", 2500))
#sD <- sD %>% mutate(value=replace(value, parameter=="pv_cost_2015", 1800))
abm_cal <- runABM(sD,Nrun = 10,simulation_end = 2022, use_parallel = T)
saveRDS(abm_cal,file.out)
